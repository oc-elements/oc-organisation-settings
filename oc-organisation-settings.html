<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-material/paper-material.html">

<link rel="import" href="../oc-core-utils/oc-api-consumer-behaviour.html">
<link rel="import" href="../oc-settingkeys-api/oc-settingkeys-api.html">
<link rel="import" href="../oc-settingtags-api/oc-settingtags-api.html">

<!--
`oc-organisation-settings`
Element for capture and display of organisation settings

@demo demo/index.html
-->

<dom-module id="oc-organisation-settings">
  <style>
    :host {
      display: block;
    }
    paper-material {
      background-color: #fff;
      padding: 10px;
      margin: 10px;
    }
  </style>

  <template>

    <oc-settingkeys-api id="settingKeysApi"></oc-settingkeys-api>
    <oc-settingtags-api id="settingTagsApi"></oc-settingtags-api>

    <template is="dom-repeat" items="[[ _categories ]]">
      <paper-material>
        <h3>[[ item.name ]]</h3>
        <template is="dom-repeat" items="[[ item.keys ]]">
          <template is="dom-if" if="[[ _isText(item) ]]">
            <div>[[ item.description ]]</div>
            <div>[[ _getSettingValue(item.id) ]]</div>
          </template>
          <template is="dom-if" if="[[ _isBoolean(item) ]]">
            <div>[[ item.description ]]</div>
            <div>[[ _getSettingValue(item.id) ]]</div>
          </template>
        </template>
      </paper-material>
    </template>


  </template>

  <script>
    Polymer({
      is: 'oc-organisation-settings',
      behaviors: [OC.Behaviours.ApiConsumer],

      properties: {
        settings: {
          type: Array,
          value: [],
        },
      },

      /*observers: [
       '_getCategories(settings)'
       ],*/

      ready: function () {
        console.log("ready");
        this._getCategories();
      },

      _isText: function(setting) {
        return setting.type === "String";
      },

      _isBoolean: function(setting) {
        return setting.type === "Boolean";
      },

      _groupByCategory: function(xs) {
        return xs.reduce(function(rv, x) {
          var category = rv.filter(function(cats) { return cats.category === x.category})[0] || {category:x.category, settings:[]};
          category.settings.push(x);
          if (!rv.some(function(element, index, array) { return element.category === x.category })) {
            rv.push(category);
          }
          return rv;
        }, []);
      },

      _getCategories: function () {
        var settingsByTagPromises = [];
        this.$.settingTagsApi.getSettingTags()
                .then(this._setPropertyResponseResults.bind(this, '_tags'))
                .catch(console.error)
                .finally(function() {
                  for (var i in this._tags) {
                    settingsByTagPromises.push(this.$.settingKeysApi.getKeysByTag(this._tags[i].id)
                            .then(function(response) {
                              this._tags[i].keys = response.results;
                            }.bind(this)))
                  }
                }.bind(this));
        Promise.all(settingsByTagPromises)
                .then(this.set.bind(this, '_categories', this._tags));
      }
    });
  </script>
</dom-module>
